{% extends 'layout.html' %}
{% set page_title = "Users" %}
{% block content %}

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/table_columns.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

<style>
  table.dataTable thead th { color:#000; }
  .table-hover tbody tr:hover { background:#f8faff; }

  /* ===== Toolbar ===== */
  #toolbar { box-shadow: 0 1px 2px rgba(0,0,0,.05); }
  #toolbar .btn { line-height: 1; }
  #toolbar .toolbar-row{
    display:flex; flex-wrap:wrap; align-items:center; justify-content:space-between;
    gap:.5rem; min-height:56px;
  }
  #toolbar .length-slot label{
    display:flex; align-items:center; gap:.4rem; margin:0; white-space:nowrap;
  }

  @media (max-width: 576px) { #globalSearch { width: 140px !important; } }

  .badge-pill { border-radius: 999px; }
  .status-btns .btn { min-width: 120px; }
  .dt-buttons { display: none !important; }
  @media print { #toolbar, .status-btns { display: none !important; } table { font-size: 12px; } }

  /* ===== Action column ===== */
  .btn-icon{
    border-radius:50%; width:28px; height:28px;
    display:inline-flex; align-items:center; justify-content:center;
    padding:0; transition:background-color .2s, transform .15s;
  }
  .btn-icon i{ font-size:12px; line-height:1; }
  .btn-icon:hover{ transform:scale(1.1); background-color:rgba(0,0,0,.05); }
  #usersTable td .btn-icon{ margin:0 !important; }

  #usersTable th.actions-cell, #usersTable td.actions-cell{
    white-space:nowrap; width:1%;
  }

  .actions-wrap{ display:inline-flex; align-items:center; flex-wrap:nowrap; gap:.6rem; }
  @supports not (gap: .6rem){
    .actions-wrap > .btn-icon{ margin-right:.6rem; }
    .actions-wrap > .btn-icon:last-child{ margin-right:0; }
  }

  #usersTable th:last-child, #usersTable td:last-child{
    border-left:1px solid #dee2e6; border-right:1px solid #dee2e6;
  }
  #usersTable td, #usersTable th{ vertical-align:middle; }

  #deviceInfoModal .lh-lg > div{ margin-bottom:.25rem; }
  .swal2-actions{ gap:.75rem !important; }

  /* ===== Pagination (as in admin_logs.html) ===== */
  /* Hide default DataTables pagination */
  .dataTables_wrapper .dataTables_paginate{ display:none !important; }
  /* Small spacing above pagination */
  nav .pagination { margin-top:.5rem; }
</style>

<div class="container py-3">

  <!-- Toolbar -->
  <div id="toolbar" class="bg-white py-2 mb-3 border rounded px-3">
    <div class="toolbar-row">
      <div class="length-slot"></div>

      <div class="d-flex align-items-center gap-2 flex-wrap">
        <button id="btnExcel" type="button" class="btn btn-success btn-sm" title="Export to Excel" aria-label="Export to Excel">
          <i class="fas fa-file-excel" aria-hidden="true"></i>
        </button>
        <button id="btnPDF" type="button" class="btn btn-danger btn-sm" title="Export to PDF" aria-label="Export to PDF">
          <i class="fas fa-file-pdf" aria-hidden="true"></i>
        </button>
        <button id="btnPrint" type="button" class="btn btn-secondary btn-sm" title="Print" aria-label="Print">
          <i class="fas fa-print" aria-hidden="true"></i>
        </button>

        <button id="refresh-btn" type="button" class="btn btn-light btn-sm" title="Refresh" aria-label="Refresh">
          <i class="fas fa-sync-alt" aria-hidden="true"></i>
        </button>

        <div class="d-flex align-items-center ms-1">
          <label for="globalSearch" class="me-2 mb-0">Search:</label>
          <input id="globalSearch" name="globalSearch" type="search" class="form-control form-control-sm" style="width: 200px;">
        </div>
        <span id="notification" class="small text-muted ms-2"></span>
      </div>
    </div>
  </div>

  <!-- Status Switcher -->
  <div class="status-btns d-flex flex-wrap align-items-center gap-2 mb-3">
    <button class="btn btn-outline-primary active" data-status="pending" id="btnPending" type="button">
      Pending <span class="badge text-bg-danger badge-pill" id="countPending">0</span>
    </button>
    <button class="btn btn-outline-success" data-status="approved" id="btnApproved" type="button">
      Approved <span class="badge text-bg-success badge-pill" id="countApproved">0</span>
    </button>
    <button class="btn btn-outline-secondary" data-status="rejected" id="btnRejected" type="button">
      Rejected <span class="badge text-bg-secondary badge-pill" id="countRejected">0</span>
    </button>
  </div>

  <!-- Users Table -->
  <div class="table-responsive">
    <table id="usersTable" class="table table-bordered table-hover align-middle w-100">
      <thead class="table-light">
        <tr>
          <th>Email</th>
          <th>Phone</th>
          <th class="d-none d-lg-table-cell">Company</th>
          <th class="d-none d-md-table-cell">Device UUID</th>
          <th class="actions-cell">Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Pagination (same as admin_logs.html) -->
  <nav>
    <ul class="pagination justify-content-center" id="pager"></ul>
  </nav>
</div>

<!-- More Info Modal -->
<div class="modal fade" id="deviceInfoModal" tabindex="-1" aria-labelledby="deviceInfoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="deviceInfoModalLabel">User / Device Info</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="lh-lg">
          <div><strong>Email:</strong> <span id="m_email"></span></div>
          <div><strong>Phone:</strong> <span id="m_phone"></span></div>
          <div><strong>Company:</strong> <span id="m_company"></span></div>
          <div><strong>Device Name:</strong> <span id="m_device_name"></span></div>
          <div><strong>Device UUID:</strong> <span id="m_device_uuid"></span></div>
          <div><strong>Registered At:</strong> <span id="m_registered_at"></span></div>
          <div><strong>Status:</strong> <span id="m_status"></span></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="{{ url_for('static', filename='js/jquery-3.6.0.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/jquery.dataTables.min.js') }}"></script>
<script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- Patch: always show Cancel button on all non-toast Swal.fire dialogs -->
<script>
  if (window.Swal && typeof Swal.fire === 'function') {
    const _orig = Swal.fire.bind(Swal);
    Swal.fire = function(opts){
      if (opts && opts.toast) return _orig;
      return _orig(Object.assign({ showCancelButton: true, cancelButtonText: 'Cancel' }, opts || {}));
    };
  }
</script>

<!-- Pass role to JavaScript -->
<script> window.ADMIN_ROLE = {{ (admin_role or '')|tojson|safe }}; </script>

<!-- External page script -->
<script src="{{ url_for('static', filename='js/newadmin.js') }}?v=1.4.0"></script>

<!-- Pager (same logic as in admin_logs.html but linked to DataTables) -->
<script>
(function () {
  // Wait until DataTable in newadmin.js is initialized
  document.addEventListener('DOMContentLoaded', function(){
    let tries = 0;
    (function waitForDT(){
      tries++;
      if (!window.jQuery) return;
      const $ = window.jQuery;
      const isReady = $.fn.dataTable && $.fn.dataTable.isDataTable('#usersTable');
      if (!isReady) { if (tries < 40) return setTimeout(waitForDT, 100); else return; }

      const dt = $('#usersTable').DataTable();
      const pager = document.getElementById('pager');

      function createItem(label, page, disabled=false, active=false){
        const li = document.createElement('li');
        li.className = `page-item ${disabled ? 'disabled' : ''} ${active ? 'active' : ''}`;
        const a = document.createElement('a');
        a.className = 'page-link';
        a.href = '#';
        a.textContent = label;
        a.onclick = (e) => {
          e.preventDefault();
          if (disabled || active) return;
          dt.page(page).draw('page');
        };
        li.appendChild(a);
        return li;
      }

      function renderPager(){
        const info = dt.page.info(); // {page, pages, ...}
        const cp = info.page + 1;    // 1-based
        const tp = Math.max(1, info.pages);

        pager.innerHTML = '';
        pager.appendChild(createItem('«', info.page - 1, cp === 1));
        const start = Math.max(1, cp - 2);
        const end   = Math.min(tp, cp + 2);
        for (let i=start; i<=end; i++){
          pager.appendChild(createItem(String(i), i-1, false, i===cp));
        }
        pager.appendChild(createItem('»', info.page + 1, cp === tp));
      }

      // Render once and on every table draw
      renderPager();
      dt.on('draw', renderPager);
    })();
  });
})();
</script>

{% endblock %}
