{% extends 'layout.html' %}
{% set page_title = "Users" %}
{% block content %}

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/table_columns.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<style>
  table.dataTable thead th { color:#000; }
  .table-hover tbody tr:hover { background:#f8faff; }

  /* ===== Toolbar ===== */
  #toolbar { box-shadow: 0 1px 2px rgba(0,0,0,.05); }
  #toolbar .btn { line-height: 1; }
  #toolbar .toolbar-row{
    display:flex; flex-wrap:wrap;
    align-items:center; justify-content:space-between;
    gap:.5rem; min-height:56px; /* توسيط رأسي جميل بين الحدين */
  }
  /* مكان "Show entries" */
  #toolbar .length-slot label{
    display:flex; align-items:center; gap:.4rem; margin:0;
    white-space:nowrap;
  }

  @media (max-width: 576px) {
    #globalSearch { width: 140px !important; }
  }

  .badge-pill { border-radius: 999px; }
  .status-btns .btn { min-width: 120px; }
  /* أخفِ أزرار DataTables الداخلية لتفادي التكرار */
  .dt-buttons { display: none !important; }
  @media print { #toolbar, .status-btns { display: none !important; } table { font-size: 12px; } }

  /* أزرار دائرية صغيرة في عمود Action */
  .btn-icon {
    border-radius: 50%;
    width: 28px; height: 28px;
    display: inline-flex; align-items: center; justify-content: center;
    padding: 0; transition: background-color .2s ease, transform .15s ease;
  }
  .btn-icon i { font-size: 12px; line-height: 1; }
  .btn-icon:hover { transform: scale(1.1); background-color: rgba(0,0,0,0.05); }
  #usersTable td .btn-icon { margin-inline-end: .25rem; }

  /* ضبط المسافات داخل المودال */
  #deviceInfoModal .lh-lg > div { margin-bottom: .25rem; }
</style>

<div class="container py-3">

  <!-- Toolbar -->
  <div id="toolbar" class="bg-white py-2 mb-3 border rounded px-3">
    <div class="toolbar-row">

      <!-- يسار: Show entries يُحقن هنا -->
      <div class="length-slot"></div>

      <!-- يمين: أزرار التصدير + تحديث + البحث -->
      <div class="d-flex align-items-center gap-2 flex-wrap">
        <button id="btnExcel" class="btn btn-success btn-sm" title="Export to Excel"><i class="fas fa-file-excel"></i></button>
        <button id="btnPDF"   class="btn btn-danger btn-sm"  title="Export to PDF"><i class="fas fa-file-pdf"></i></button>
        <button id="btnPrint" class="btn btn-secondary btn-sm" title="Print"><i class="fas fa-print"></i></button>

        <button id="refresh-btn" type="button" class="btn btn-light btn-sm" title="Refresh">
          <i class="fas fa-sync-alt"></i>
        </button>

        <div class="d-flex align-items-center ms-1">
          <label for="globalSearch" class="me-2 mb-0">Search:</label>
          <input id="globalSearch" type="search" class="form-control form-control-sm" style="width: 200px;">
        </div>
        <span id="notification" class="small text-muted ms-2"></span>
      </div>

    </div>
  </div>

  <!-- Status Switcher -->
  <div class="status-btns d-flex flex-wrap align-items-center gap-2 mb-3">
    <button class="btn btn-outline-primary active" data-status="pending"  id="btnPending">
      Pending <span class="badge text-bg-danger badge-pill" id="countPending">0</span>
    </button>
    <button class="btn btn-outline-success" data-status="approved" id="btnApproved">
      Approved <span class="badge text-bg-success badge-pill" id="countApproved">0</span>
    </button>
    <button class="btn btn-outline-secondary" data-status="rejected" id="btnRejected">
      Rejected <span class="badge text-bg-secondary badge-pill" id="countRejected">0</span>
    </button>
  </div>

  <!-- Users Table -->
  <div class="table-responsive">
    <table id="usersTable" class="table table-bordered table-hover align-middle w-100">
      <thead class="table-light">
        <tr>
          <th>Email</th>
          <th>Phone</th>
          <th class="d-none d-md-table-cell">Device UUID</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- More Info Modal -->
<div class="modal fade" id="deviceInfoModal" tabindex="-1" aria-labelledby="deviceInfoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="deviceInfoModalLabel">User / Device Info</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="lh-lg">
          <div><strong>Email:</strong> <span id="m_email"></span></div>
          <div><strong>Phone:</strong> <span id="m_phone"></span></div>
          <div><strong>Company:</strong> <span id="m_company"></span></div>
          <div><strong>Device Name:</strong> <span id="m_device_name"></span></div>
          <div><strong>Device UUID:</strong> <span id="m_device_uuid"></span></div>
          <div><strong>Registered At:</strong> <span id="m_registered_at"></span></div>
          <div><strong>Status:</strong> <span id="m_status"></span></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>

<script>
  const CAN_EDIT = ["super","limited"].includes(("{{ admin_role }}").trim().toLowerCase());
  let payload = { pending_users: [], approved_users: [], rejected_users: [] };
  let currentStatus = 'pending';
  let dt = null;

  function badge(s) {
    const map = { pending: 'secondary', approved: 'success', rejected: 'danger' };
    return '<span class="badge text-bg-' + (map[s] || 'secondary') + ' text-uppercase">' + s + '</span>';
  }

  function esc(s){
    return String(s ?? '')
      .replace(/&/g,'&amp;').replace(/</g,'&lt;')
      .replace(/>/g,'&gt;').replace(/"/g,'&quot;')
      .replace(/'/g,'&#39;');
  }

  function infoButton(u, status) {
    return '<button type="button" class="btn btn-sm btn-primary btn-icon info-btn" title="More info" ' +
           'data-email="'+esc(u.email)+'" data-phone="'+esc(u.phone || "—")+'" data-company="'+esc(u.company_name || "—")+'" ' +
           'data-device_name="'+esc(u.device_name || "—")+'" data-device_uuid="'+esc(u.device_uuid || "—")+'" ' +
           'data-registered="'+esc(u.registered_at || u.created_at || "—")+'" data-status="'+esc(status)+'">' +
           '<i class="fas fa-info"></i></button>';
  }

  function actionButtons(u, status) {
    const emailEnc = encodeURIComponent(u.email || '');
    let html = infoButton(u, status);
    if (CAN_EDIT) {
      if (status === 'pending') {
        html += '<button type="button" class="btn btn-sm btn-success btn-icon approve-btn" data-email="'+emailEnc+'" title="Approve"><i class="fas fa-check"></i></button>';
        html += '<button type="button" class="btn btn-sm btn-warning btn-icon reject-btn"  data-email="'+emailEnc+'" title="Reject"><i class="fas fa-times"></i></button>';
      }
      html += '<button type="button" class="btn btn-sm btn-danger btn-icon delete-btn" data-email="'+emailEnc+'" title="Delete"><i class="fas fa-trash"></i></button>';
    }
    return html;
  }

  function toTableData(status) {
    var arr = status === 'approved' ? (payload.approved_users || [])
            : status === 'rejected' ? (payload.rejected_users || [])
            : (payload.pending_users || []);
    return arr.map(function(u){
      return {
        email: u.email || '',
        phone: u.phone || '—',
        device_uuid: u.device_uuid || '—',
        action_html: actionButtons(u, status)
      };
    });
  }

  function initTableOnce() {
    if (dt) return;
    dt = $('#usersTable').DataTable({
      autoWidth: false,
      dom: 'lBtp',   // نعرض length + أزرار (سنخفي أزرار DT ونستخدم المخصّصة)
      pageLength: 25,
      data: [],
      columns: [
        { data: 'email', title: 'Email' },
        { data: 'phone', title: 'Phone' },
        { data: 'device_uuid', title: 'Device UUID', className: 'd-none d-md-table-cell' },
        { data: 'action_html', title: 'Action', orderable: false, className: 'text-center' }
      ],
      buttons: [
        { extend: 'excel', title: () => 'users_' + currentStatus,
          exportOptions: { columns: ':visible:not(:last-child)' } },
        { extend: 'pdf',   title: () => 'users_' + currentStatus,
          orientation: 'landscape', pageSize: 'A4',
          exportOptions: { columns: ':visible:not(:last-child)' } },
        { extend: 'print', title: () => 'Users - ' + currentStatus.toUpperCase(),
          exportOptions: { columns: ':visible:not(:last-child)' } }
      ],
      initComplete: function(){
        /* انقل عنصر "Show _MENU_ entries" إلى يسار شريط الأدوات */
        const $len = $('#usersTable_length');
        if ($len.length) {
          $len.find('label').appendTo('#toolbar .length-slot');     // ضع الليبل كاملاً
          $len.remove();                                            // أزل الغلاف القديم
        }
      }
    });
  }

  function redraw(status) {
    currentStatus = status || currentStatus;
    initTableOnce();
    dt.clear().rows.add(toTableData(currentStatus)).draw();
    const q = $('#globalSearch').val() || '';
    if (q) dt.search(q).draw();
  }

  function refreshCounts() {
    $('#countPending').text((payload.pending_users || []).length);
    $('#countApproved').text((payload.approved_users || []).length);
    $('#countRejected').text((payload.rejected_users || []).length);
  }

  function wireRefresh(){
    $('#refresh-btn').off('click').on('click', function(e){
      e.preventDefault();
      fetchUsers();
    });
  }

  function fetchUsers() {
    $("#refresh-btn").prop("disabled", true).html('<i class="fas fa-spinner fa-spin"></i>');
    $.get("/newadmin_data")
      .done(function (data) {
        payload = {
          pending_users:  data.pending_users  || [],
          approved_users: data.approved_users || [],
          rejected_users: data.rejected_users || []
        };
        refreshCounts();
        redraw(currentStatus);
      })
      .fail(function () {
        $('#notification').text("Error loading user data.").fadeIn().delay(2500).fadeOut();
      })
      .always(function () {
        $("#refresh-btn").prop("disabled", false).html('<i class="fas fa-sync-alt"></i>');
        wireRefresh();
      });
  }

  // ===== Actions
  $(document).on("click", ".approve-btn", function (e) {
    e.preventDefault();
    const email = String($(this).data("email") || '');
    $.post("/newapprove/" + email)
      .done(function(){ fetchUsers(); })
      .fail(function(xhr){ alert("Approval failed: " + (xhr.responseText || xhr.status)); });
  });

  $(document).on("click", ".reject-btn", function (e) {
    e.preventDefault();
    const email = String($(this).data("email") || '');
    $.post("/newreject/" + email)
      .done(function(){ fetchUsers(); })
      .fail(function(xhr){ alert("Rejection failed: " + (xhr.responseText || xhr.status)); });
  });

  $(document).on("click", ".delete-btn", function (e) {
    e.preventDefault();
    const email = String($(this).data("email") || '');
    if (!confirm("Delete this user?")) return;
    $.post("/newdelete_user/" + email)
      .done(function(){ fetchUsers(); })
      .fail(function(xhr){ alert("Delete failed: " + (xhr.responseText || xhr.status)); });
  });

  // ===== More Info modal
  $(document).on("click", ".info-btn", function(){
    $('#m_email').text($(this).data('email') || '—');
    $('#m_phone').text($(this).data('phone') || '—');
    $('#m_company').text($(this).data('company') || '—');
    $('#m_device_name').text($(this).data('device_name') || '—');
    $('#m_device_uuid').text($(this).data('device_uuid') || '—');
    $('#m_registered_at').text($(this).data('registered') || '—');
    $('#m_status').html(badge($(this).data('status') || 'pending'));
    new bootstrap.Modal(document.getElementById("deviceInfoModal")).show();
  });

  // ===== Toolbar hooks
  $(function () {
    // تفعيل التصدير من الأزرار العليا
    $('#btnExcel').on('click', function(){ if (dt) dt.button(0).trigger(); });
    $('#btnPDF').on('click',   function(){ if (dt) dt.button(1).trigger(); });
    $('#btnPrint').on('click', function(){ if (dt) dt.button(2).trigger(); });

    $('#globalSearch').on('input', function(){ if (dt) dt.search(this.value).draw(); });

    $('[data-status]').on('click', function(){
      $('[data-status]').removeClass('active');
      $(this).addClass('active');
      redraw($(this).data('status'));
    });

    wireRefresh();
    initTableOnce();
    fetchUsers();
  });
</script>

{% endblock %}
