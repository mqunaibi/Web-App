{% extends 'layout.html' %}
{% set page_title = "Users" %}
{% block content %}

<!-- DataTables 1.13.8 + Buttons 2.4.2 -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/table_columns.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<style>
  table.dataTable thead th { color:#000; }
  #toolbar { box-shadow: 0 1px 2px rgba(0,0,0,.05); }
  #toolbar .btn { line-height: 1; }
  @media (max-width: 576px) { #toolbarSearch { width: 140px !important; } }
  .table-hover tbody tr:hover { background:#f8faff; }
  table.dataTable th:last-child,
  table.dataTable td:last-child { text-align:center; white-space:nowrap; width:110px; }
  .action-btn { padding: 0 .25rem; }
  .action-btn i { font-size: 1rem; }
  .text-clip {
    display:inline-block; max-width: 260px;
    overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    vertical-align: bottom;
  }

  /* ====== موبايل: وضع مضغوط يُظهر عمودين فقط (Email + Action) عند وجود كلاس mobile-compact على الحاوية ====== */
  @media (max-width: 576px) {
    /* إخفاء Phone (2) + Device Name (3) + Device UUID (4) لكل الجداول عندما تكون الحاوية mobile-compact */
    #newadmin-container.mobile-compact #user-table-1 th:nth-child(2),
    #newadmin-container.mobile-compact #user-table-1 td:nth-child(2),
    #newadmin-container.mobile-compact #user-table-1 th:nth-child(3),
    #newadmin-container.mobile-compact #user-table-1 td:nth-child(3),
    #newadmin-container.mobile-compact #user-table-1 th:nth-child(4),
    #newadmin-container.mobile-compact #user-table-1 td:nth-child(4),

    #newadmin-container.mobile-compact #user-table-2 th:nth-child(2),
    #newadmin-container.mobile-compact #user-table-2 td:nth-child(2),
    #newadmin-container.mobile-compact #user-table-2 th:nth-child(3),
    #newadmin-container.mobile-compact #user-table-2 td:nth-child(3),
    #newadmin-container.mobile-compact #user-table-2 th:nth-child(4),
    #newadmin-container.mobile-compact #user-table-2 td:nth-child(4),

    #newadmin-container.mobile-compact #user-table-3 th:nth-child(2),
    #newadmin-container.mobile-compact #user-table-3 td:nth-child(2),
    #newadmin-container.mobile-compact #user-table-3 th:nth-child(3),
    #newadmin-container.mobile-compact #user-table-3 td:nth-child(3),
    #newadmin-container.mobile-compact #user-table-3 th:nth-child(4),
    #newadmin-container.mobile-compact #user-table-3 td:nth-child(4) {
      display: none !important;
    }

    /* تحسين عرض العمودين الباقيين */
    #newadmin-container.mobile-compact #user-table-1,
    #newadmin-container.mobile-compact #user-table-2,
    #newadmin-container.mobile-compact #user-table-3 { table-layout: fixed; }

    #newadmin-container.mobile-compact #user-table-1 th:nth-child(1),
    #newadmin-container.mobile-compact #user-table-1 td:nth-child(1),
    #newadmin-container.mobile-compact #user-table-2 th:nth-child(1),
    #newadmin-container.mobile-compact #user-table-2 td:nth-child(1),
    #newadmin-container.mobile-compact #user-table-3 th:nth-child(1),
    #newadmin-container.mobile-compact #user-table-3 td:nth-child(1) {
      width: 75%;
      overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    #newadmin-container.mobile-compact #user-table-1 th:last-child,
    #newadmin-container.mobile-compact #user-table-1 td:last-child,
    #newadmin-container.mobile-compact #user-table-2 th:last-child,
    #newadmin-container.mobile-compact #user-table-2 td:last-child,
    #newadmin-container.mobile-compact #user-table-3 th:last-child,
    #newadmin-container.mobile-compact #user-table-3 td:last-child {
      width: 25%; text-align: center;
    }
  }
</style>

<div id="newadmin-container" class="container py-2">
  <!-- شريط أدوات أعلى الجدول -->
  <div id="toolbar" class="sticky-top bg-white py-2 mb-3 border rounded px-2" style="top: 70px; z-index: 10;">
    <div class="d-flex flex-wrap align-items-center gap-2">
      <button id="btnExcel" class="btn btn-success btn-sm" title="Export to Excel">
        <i class="fas fa-file-excel"></i>
      </button>
      <button id="btnPDF" class="btn btn-danger btn-sm" title="Export to PDF">
        <i class="fas fa-file-pdf"></i>
      </button>
      <button id="btnPrint" class="btn btn-secondary btn-sm" title="Print">
        <i class="fas fa-print"></i>
      </button>

      <button id="refresh-btn" type="button" class="btn btn-light btn-sm ms-auto" title="Refresh">
        <i class="fas fa-sync-alt"></i>
      </button>

      <div class="ms-2 d-flex align-items-center">
        <label for="toolbarSearch" class="me-2 mb-0">Search:</label>
        <input id="toolbarSearch" type="search" class="form-control form-control-sm" style="width: 200px;">
      </div>

      <!-- زر تبديل الأعمدة للموبايل فقط -->
      <button id="toggle-cols-btn" type="button" class="btn btn-outline-secondary btn-sm d-sm-none" title="Toggle columns">
        More columns
      </button>

      <!-- عنصر الإشعار داخل شريط الأدوات -->
      <span id="notification" class="small text-muted ms-3"></span>
    </div>
  </div>

  <!-- تبويبات الحالة + قائمة الموبايل -->
  <div class="mb-2">
    <!-- تبويبات لسطح المكتب/التابلت -->
    <ul class="nav nav-tabs d-none d-sm-flex" id="userTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active d-inline-flex align-items-center gap-2" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending" type="button" role="tab">
          Pending
          <span id="pending-count" class="badge rounded-pill text-bg-danger">0</span>
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link d-inline-flex align-items-center gap-2" id="approved-tab" data-bs-toggle="tab" data-bs-target="#approved" type="button" role="tab">
          Approved
          <span id="approved-count" class="badge rounded-pill text-bg-success">0</span>
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link d-inline-flex align-items-center gap-2" id="rejected-tab" data-bs-toggle="tab" data-bs-target="#rejected" type="button" role="tab">
          Rejected
          <span id="rejected-count" class="badge rounded-pill text-bg-primary">0</span>
        </button>
      </li>
    </ul>

    <!-- قائمة اختيار للموبايل فقط -->
    <div class="d-sm-none mt-2">
      <select id="usersTabsSelect" class="form-select form-select-sm" aria-label="Users tabs">
        <option value="#pending">Pending (0)</option>
        <option value="#approved">Approved (0)</option>
        <option value="#rejected">Rejected (0)</option>
      </select>
    </div>
  </div>

  <div class="tab-content mt-2" id="userTabContent">
    <!-- Pending -->
    <div class="tab-pane fade show active" id="pending" role="tabpanel" aria-labelledby="pending-tab">
      <div class="table-responsive">
        <table id="user-table-1" class="table table-bordered table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>Email</th>
              <th>Phone</th>
              <th>Device Name</th>
              <th class="d-none d-md-table-cell">Device UUID</th>
              {% if admin_role in ['super','limited'] %}
                <th>Action</th>
              {% endif %}
            </tr>
          </thead>
          <tbody id="pending-users"></tbody>
        </table>
      </div>
    </div>

    <!-- Approved -->
    <div class="tab-pane fade" id="approved" role="tabpanel" aria-labelledby="approved-tab">
      <div class="table-responsive">
        <table id="user-table-2" class="table table-bordered table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>Email</th>
              <th>Phone</th>
              <th>Device Name</th>
              <th class="d-none d-md-table-cell">Device UUID</th>
              {% if admin_role in ['super','limited'] %}
                <th>Action</th>
              {% endif %}
            </tr>
          </thead>
          <tbody id="approved-users"></tbody>
        </table>
      </div>
    </div>

    <!-- Rejected -->
    <div class="tab-pane fade" id="rejected" role="tabpanel" aria-labelledby="rejected-tab">
      <div class="table-responsive">
        <table id="user-table-3" class="table table-bordered table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>Email</th>
              <th>Phone</th>
              <th>Device Name</th>
              <th class="d-none d-md-table-cell">Device UUID</th>
              {% if admin_role in ['super','limited'] %}
                <th>Action</th>
              {% endif %}
            </tr>
          </thead>
          <tbody id="rejected-users"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Device Info -->
<div class="modal fade" id="deviceInfoModal" tabindex="-1" aria-labelledby="deviceInfoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="deviceInfoModalLabel">Device Info</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p><strong>Device Name:</strong> <span id="modal-device-name"></span></p>
        <p><strong>Device UUID:</strong> <span id="modal-device-uuid"></span></p>
        <p><strong>Registered At:</strong> <span id="modal-registered-at"></span></p>
      </div>
    </div>
  </div>
</div>

<!-- سكربتات DataTables + Buttons -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Bootstrap 5.3.3 -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- DataTables core + BS5 integration -->
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>

<!-- Buttons 2.4.2 -->
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>

<script>
  const CAN_EDIT = ["super","limited"].includes(("{{ admin_role }}").trim().toLowerCase());

  function initDataTable(id) {
    if ($.fn.DataTable.isDataTable(id)) {
      $(id).DataTable().clear().destroy();
    }
    return $(id).DataTable({
      autoWidth: false,
      dom: 'rt<"mt-2"lp>',
      buttons: [
        {
          extend: 'excel',
          className: 'buttons-excel',
          exportOptions: { columns: function(idx, data, node) { return $(node).text().trim() !== 'Action'; } }
        },
        {
          extend: 'pdf',
          className: 'buttons-pdf',
          exportOptions: { columns: function(idx, data, node) { return $(node).text().trim() !== 'Action'; } }
        },
        {
          extend: 'print',
          className: 'buttons-print',
          exportOptions: { columns: function(idx, data, node) { return $(node).text().trim() !== 'Action'; } },
          customize: function ( win ) {
            $(win.document.body).css('font-family', 'system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif');
            $(win.document.body).find('h1').css({'text-align': 'center', 'font-size': '18pt'});
            $(win.document.body).find('table').css({'margin': '0 auto', 'font-size': '10pt'});
          }
        }
      ]
    });
  }

  function showNotification(message) {
    $('#notification').text(message).fadeIn();
    setTimeout(() => $('#notification').fadeOut(), 3000);
  }

  function buildRow(user, actionsHtml) {
    const phoneCell      = user.phone       ? user.phone       : '<span class="text-muted">—</span>';
    const deviceNameCell = user.device_name ? user.device_name : '<span class="text-muted">—</span>';
    const uuidCell       = user.device_uuid ? `<span class="text-clip" title="${user.device_uuid}">${user.device_uuid}</span>` : '<span class="text-muted">—</span>';
    const actionCell = CAN_EDIT ? `<td class="text-center">${actionsHtml}</td>` : '';
    return `<tr><td>${user.email}</td><td>${phoneCell}</td><td>${deviceNameCell}</td><td>${uuidCell}</td>${actionCell}</tr>`;
  }

  function buildActions(user, status) {
    const infoBtn = `<button type="button" class="btn btn-link action-btn info-btn" data-name="${user.device_name || ''}" data-uuid="${user.device_uuid || ''}" data-registered="${user.registered_at || ''}" title="Info"><i class="fas fa-info-circle"></i></button>`;
    if (status === "pending") {
      return `<button type="button" class="btn btn-link action-btn approve-btn" data-email="${user.email}" title="Approve"><i class="fas fa-check text-success"></i></button>
              <button type="button" class="btn btn-link action-btn reject-btn" data-email="${user.email}" title="Reject"><i class="fas fa-times text-danger"></i></button>
              ${infoBtn}`;
    }
    if (status === "approved") {
      return `${infoBtn}
              <button type="button" class="btn btn-link action-btn delete-btn" data-email="${user.email}" title="Delete"><i class="fas fa-trash text-danger"></i></button>`;
    }
    return `<button type="button" class="btn btn-link action-btn delete-btn" data-email="${user.email}" title="Delete"><i class="fas fa-trash text-danger"></i></button>`;
  }

  // تحديث تسميات قائمة الموبايل حسب عدّادات التبويبات
  function updateMobileSelectLabels() {
    const select = document.getElementById('usersTabsSelect');
    if (!select) return;
    const labels = {
      '#pending':  `Pending (${document.getElementById('pending-count')?.textContent || '0'})`,
      '#approved': `Approved (${document.getElementById('approved-count')?.textContent || '0'})`,
      '#rejected': `Rejected (${document.getElementById('rejected-count')?.textContent || '0'})`
    };
    Array.from(select.options).forEach(opt => {
      if (labels[opt.value]) opt.textContent = labels[opt.value];
    });
  }

  function refreshTables(data) {
    const tables = [
      { id: '#user-table-1', users: data.pending_users  || [], status: 'pending'  },
      { id: '#user-table-2', users: data.approved_users || [], status: 'approved' },
      { id: '#user-table-3', users: data.rejected_users || [], status: 'rejected' }
    ];
    tables.forEach(({ id, users, status }) => {
      if ($.fn.DataTable.isDataTable(id)) {
        $(id).DataTable().clear().destroy();
      }
      const $body = $(id).find('tbody').empty();
      users.forEach(user => {
        const actions = CAN_EDIT ? buildActions(user, status) : '';
        $body.append(buildRow(user, actions));
      });
      initDataTable(id);
    });
    $("#pending-count").text((data.pending_users  || []).length);
    $("#approved-count").text((data.approved_users || []).length);
    $("#rejected-count").text((data.rejected_users || []).length);

    updateMobileSelectLabels();
  }

  function fetchUsers() {
    $("#refresh-btn").prop("disabled", true).html('<i class="fas fa-spinner fa-spin"></i>');
    $.get("/newadmin_data")
      .done(data => refreshTables(data))
      .fail(() => showNotification("Error loading user data."))
      .always(() => $("#refresh-btn").prop("disabled", false).html('<i class="fas fa-sync-alt"></i>'));
  }

  // ====== تحكم وضع الأعمدة على الموبايل ======
  function updateToggleBtnLabel() {
    const btn = document.getElementById('toggle-cols-btn');
    const compact = document.getElementById('newadmin-container')?.classList.contains('mobile-compact');
    if (btn) btn.textContent = compact ? 'More columns' : 'Fewer columns';
  }

  function toggleMobileColumns() {
    const container = document.getElementById('newadmin-container');
    if (!container) return;
    const nowCompact = !container.classList.contains('mobile-compact');
    container.classList.toggle('mobile-compact', nowCompact);
    localStorage.setItem('mobileCompact', nowCompact ? '1' : '0');
    updateToggleBtnLabel();
  }

  function applyInitialMobileCompact() {
    const container = document.getElementById('newadmin-container');
    if (!container) return;

    const saved = localStorage.getItem('mobileCompact'); // '1' أو '0' أو null
    const isSmall = window.matchMedia('(max-width: 576px)').matches;
    const shouldCompact = (saved === '1') || (saved === null && isSmall); // افتراضيًا مُفعّل على الموبايل

    container.classList.toggle('mobile-compact', !!shouldCompact);
    updateToggleBtnLabel();
  }
  // ============================================

  /* ====== مانع عام لسلوك الأزرار + المعالجات (كما في الملف الأصلي) ====== */
  $(document).on("click", ".action-btn", function (e) {
    e.preventDefault();
    e.stopPropagation();
  });

  $(document).on("click", ".approve-btn", function () {
    $.post(`/newapprove/${encodeURIComponent($(this).data("email"))}`)
      .done(() => { showNotification("User approved successfully!"); fetchUsers(); })
      .fail(() => { showNotification("Approval failed."); });
  });

  $(document).on("click", ".reject-btn", function () {
    $.post(`/newreject/${encodeURIComponent($(this).data("email"))}`)
      .done(() => { showNotification("User rejected successfully!"); fetchUsers(); })
      .fail(() => { showNotification("Rejection failed."); });
  });

  $(document).on("click", ".delete-btn", function () {
    $.post(`/newdelete_user/${encodeURIComponent($(this).data("email"))}`)
      .done(() => { showNotification("User deleted."); fetchUsers(); })
      .fail(() => { showNotification("Delete failed."); });
  });

  $(document).on("click", ".info-btn", function () {
    $("#modal-device-name").text($(this).data("name") || "N/A");
    $("#modal-device-uuid").text($(this).data("uuid") || "N/A");
    $("#modal-registered-at").text($(this).data("registered") || "N/A");
    new bootstrap.Modal(document.getElementById("deviceInfoModal")).show();
  });
  /* ================================================================ */

  $(function () {
    function getActiveTable() {
      const activeId = $('.tab-pane.active table').attr('id');
      return activeId ? $('#' + activeId).DataTable() : null;
    }

    // أزرار التصدير والبحث تعمل على التبويب النشِط
    $('#btnExcel').on('click', () => { const dt = getActiveTable(); if (dt) dt.button('.buttons-excel').trigger(); });
    $('#btnPDF').on('click',   () => { const dt = getActiveTable(); if (dt) dt.button('.buttons-pdf').trigger(); });
    $('#btnPrint').on('click', () => { const dt = getActiveTable(); if (dt) dt.button('.buttons-print').trigger(); });
    $('#toolbarSearch').on('keyup change', function () { const dt = getActiveTable(); if (dt) dt.search(this.value).draw(); });
    $('#refresh-btn').on('click', e => { e.preventDefault(); fetchUsers(); });

    // مزامنة تبويبات سطح المكتب مع قائمة الموبايل
    $(document).on('shown.bs.tab', '[data-bs-toggle="tab"]', function (ev) {
      $('#toolbarSearch').val('');
      const dt = getActiveTable(); if (dt) dt.search('').draw();
      const href = ev.target.getAttribute('data-bs-target');
      const select = document.getElementById('usersTabsSelect');
      if (select && select.value !== href) select.value = href;
    });

    // من قائمة الموبايل إلى التبويبات
    const mobileSelect = document.getElementById('usersTabsSelect');
    if (mobileSelect) {
      mobileSelect.addEventListener('change', function (e) {
        const target = e.target.value;
        const link = document.querySelector(`[data-bs-toggle="tab"][data-bs-target="${target}"]`);
        if (link) { new bootstrap.Tab(link).show(); }
      });
    }

    // تفعيل وضع الأعمدة للموبايل + ربط زر التبديل + تحديث اللابل عند تغيير الحجم
    applyInitialMobileCompact();
    const toggleBtn = document.getElementById('toggle-cols-btn');
    if (toggleBtn) toggleBtn.addEventListener('click', toggleMobileColumns);
    window.addEventListener('resize', updateToggleBtnLabel);

    fetchUsers();
    updateMobileSelectLabels();
  });
</script>

{% endblock %}
