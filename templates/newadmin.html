{% extends 'layout.html' %}
{% block content %}

<!-- DataTables 1.13.8 + Buttons 2.4.2 -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/table_columns.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<style>
  table.dataTable thead th { color:#000; }
  #toolbar { box-shadow: 0 1px 2px rgba(0,0,0,.05); }
  #toolbar .btn { line-height: 1; }
  @media (max-width: 576px) { #toolbarSearch { width: 140px !important; } }
  .table-hover tbody tr:hover { background:#f8faff; }
  table.dataTable th:last-child,
  table.dataTable td:last-child { text-align:center; white-space:nowrap; width:110px; }
  .action-btn { padding: 0 .25rem; }
  .action-btn i { font-size: 1rem; }
  .text-clip {
    display:inline-block; max-width: 260px;
    overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    vertical-align: bottom;
  }
</style>

<div class="container py-2">
  <!-- شريط أدوات أعلى الجدول (بدون العنوان الداخلي) -->
  <div id="toolbar" class="sticky-top bg-white py-2 mb-3 border rounded px-2" style="top: 70px; z-index: 10;">
    <div class="d-flex flex-wrap align-items-center gap-2">
      <button id="btnExcel" class="btn btn-success btn-sm" title="Export to Excel">
        <i class="fas fa-file-excel"></i>
      </button>
      <button id="btnPDF" class="btn btn-danger btn-sm" title="Export to PDF">
        <i class="fas fa-file-pdf"></i>
      </button>
      <button id="btnPrint" class="btn btn-secondary btn-sm" title="Print">
        <i class="fas fa-print"></i>
      </button>

      <button id="refresh-btn" type="button" class="btn btn-light btn-sm ms-auto" title="Refresh">
        <i class="fas fa-sync-alt"></i>
      </button>

      <div class="ms-2 d-flex align-items-center">
        <label for="toolbarSearch" class="me-2 mb-0">Search:</label>
        <input id="toolbarSearch" type="search" class="form-control form-control-sm" style="width: 200px;">
      </div>

      <!-- عنصر الإشعار داخل شريط الأدوات -->
      <span id="notification" class="small text-muted ms-3"></span>
    </div>
  </div>

  <!-- تبويبات الحالة -->
  <ul class="nav nav-tabs" id="userTab" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active d-inline-flex align-items-center gap-2" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending" type="button" role="tab">
        Pending
        <span id="pending-count" class="badge rounded-pill text-bg-danger">0</span>
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link d-inline-flex align-items-center gap-2" id="approved-tab" data-bs-toggle="tab" data-bs-target="#approved" type="button" role="tab">
        Approved
        <span id="approved-count" class="badge rounded-pill text-bg-success">0</span>
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link d-inline-flex align-items-center gap-2" id="rejected-tab" data-bs-toggle="tab" data-bs-target="#rejected" type="button" role="tab">
        Rejected
        <span id="rejected-count" class="badge rounded-pill text-bg-primary">0</span>
      </button>
    </li>
  </ul>

  <div class="tab-content mt-3" id="userTabContent">
    <!-- Pending -->
    <div class="tab-pane fade show active" id="pending" role="tabpanel" aria-labelledby="pending-tab">
      <div class="table-responsive">
        <table id="user-table-1" class="table table-bordered table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>Email</th>
              <th>Phone</th>
              <th>Device Name</th>
              <th class="d-none d-md-table-cell">Device UUID</th>
              {% if admin_role in ['super','limited'] %}
                <th>Action</th>
              {% endif %}
            </tr>
          </thead>
          <tbody id="pending-users"></tbody>
        </table>
      </div>
    </div>

    <!-- Approved -->
    <div class="tab-pane fade" id="approved" role="tabpanel" aria-labelledby="approved-tab">
      <div class="table-responsive">
        <table id="user-table-2" class="table table-bordered table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>Email</th>
              <th>Phone</th>
              <th>Device Name</th>
              <th class="d-none d-md-table-cell">Device UUID</th>
              {% if admin_role in ['super','limited'] %}
                <th>Action</th>
              {% endif %}
            </tr>
          </thead>
          <tbody id="approved-users"></tbody>
        </table>
      </div>
    </div>

    <!-- Rejected -->
    <div class="tab-pane fade" id="rejected" role="tabpanel" aria-labelledby="rejected-tab">
      <div class="table-responsive">
        <table id="user-table-3" class="table table-bordered table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>Email</th>
              <th>Phone</th>
              <th>Device Name</th>
              <th class="d-none d-md-table-cell">Device UUID</th>
              {% if admin_role in ['super','limited'] %}
                <th>Action</th>
              {% endif %}
            </tr>
          </thead>
          <tbody id="rejected-users"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Device Info -->
<div class="modal fade" id="deviceInfoModal" tabindex="-1" aria-labelledby="deviceInfoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="deviceInfoModalLabel">Device Info</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p><strong>Device Name:</strong> <span id="modal-device-name"></span></p>
        <p><strong>Device UUID:</strong> <span id="modal-device-uuid"></span></p>
        <p><strong>Registered At:</strong> <span id="modal-registered-at"></span></p>
      </div>
    </div>
  </div>
</div>

<!-- سكربتات DataTables + Buttons -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Bootstrap 5.3.3 -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- DataTables core + BS5 integration -->
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>

<!-- Buttons 2.4.2 -->
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>

<script>
  const CAN_EDIT = ["super","limited"].includes(("{{ admin_role }}").trim().toLowerCase());

  function initDataTable(id) {
    if ($.fn.DataTable.isDataTable(id)) {
      $(id).DataTable().clear().destroy();
    }
    return $(id).DataTable({
      autoWidth: false,
      dom: 'rt<"mt-2"lp>',
      buttons: [
        {
          extend: 'excel',
          className: 'buttons-excel',
          exportOptions: { columns: function(idx, data, node) { return $(node).text().trim() !== 'Action'; } }
        },
        {
          extend: 'pdf',
          className: 'buttons-pdf',
          exportOptions: { columns: function(idx, data, node) { return $(node).text().trim() !== 'Action'; } }
        },
        {
          extend: 'print',
          className: 'buttons-print',
          exportOptions: { columns: function(idx, data, node) { return $(node).text().trim() !== 'Action'; } },
          customize: function ( win ) {
            $(win.document.body).css('font-family', 'system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif');
            $(win.document.body).find('h1').css({'text-align': 'center', 'font-size': '18pt'});
            $(win.document.body).find('table').css({'margin': '0 auto', 'font-size': '10pt'});
          }
        }
      ]
    });
  }

  function showNotification(message) {
    $('#notification').text(message).fadeIn();
    setTimeout(() => $('#notification').fadeOut(), 3000);
  }

  function buildRow(user, actionsHtml) {
    const phoneCell      = user.phone       ? user.phone       : '<span class="text-muted">—</span>';
    const deviceNameCell = user.device_name ? user.device_name : '<span class="text-muted">—</span>';
    const uuidCell       = user.device_uuid ? `<span class="text-clip" title="${user.device_uuid}">${user.device_uuid}</span>` : '<span class="text-muted">—</span>';
    const actionCell = CAN_EDIT ? `<td class="text-center">${actionsHtml}</td>` : '';
    return `<tr><td>${user.email}</td><td>${phoneCell}</td><td>${deviceNameCell}</td><td>${uuidCell}</td>${actionCell}</tr>`;
  }

  function buildActions(user, status) {
    const infoBtn = `<button class="btn btn-link action-btn info-btn" data-name="${user.device_name || ''}" data-uuid="${user.device_uuid || ''}" data-registered="${user.registered_at || ''}" title="Info"><i class="fas fa-info-circle"></i></button>`;
    if (status === "pending") {
      return `<button class="btn btn-link action-btn approve-btn" data-email="${user.email}" title="Approve"><i class="fas fa-check text-success"></i></button>
              <button class="btn btn-link action-btn reject-btn" data-email="${user.email}" title="Reject"><i class="fas fa-times text-danger"></i></button>
              ${infoBtn}`;
    }
    if (status === "approved") {
      return `${infoBtn}
              <button class="btn btn-link action-btn delete-btn" data-email="${user.email}" title="Delete"><i class="fas fa-trash text-danger"></i></button>`;
    }
    return `<button class="btn btn-link action-btn delete-btn" data-email="${user.email}" title="Delete"><i class="fas fa-trash text-danger"></i></button>`;
  }

  function refreshTables(data) {
    const tables = [
      { id: '#user-table-1', users: data.pending_users  || [], status: 'pending'  },
      { id: '#user-table-2', users: data.approved_users || [], status: 'approved' },
      { id: '#user-table-3', users: data.rejected_users || [], status: 'rejected' }
    ];
    tables.forEach(({ id, users, status }) => {
      if ($.fn.DataTable.isDataTable(id)) {
        $(id).DataTable().clear().destroy();
      }
      const $body = $(id).find('tbody').empty();
      users.forEach(user => {
        const actions = CAN_EDIT ? buildActions(user, status) : '';
        $body.append(buildRow(user, actions));
      });
      initDataTable(id);
    });
    $("#pending-count").text((data.pending_users  || []).length);
    $("#approved-count").text((data.approved_users || []).length);
    $("#rejected-count").text((data.rejected_users || []).length);
  }

  function fetchUsers() {
    $("#refresh-btn").prop("disabled", true).html('<i class="fas fa-spinner fa-spin"></i>');
    $.get("/newadmin_data")
      .done(data => refreshTables(data))
      .fail(() => showNotification("Error loading user data."))
      .always(() => $("#refresh-btn").prop("disabled", false).html('<i class="fas fa-sync-alt"></i>'));
  }

  $(document).on("click", ".approve-btn", function () {
    $.post(`/newapprove/${encodeURIComponent($(this).data("email"))}`)
      .done(() => { showNotification("User approved successfully!"); fetchUsers(); })
      .fail(() => { showNotification("Approval failed."); });
  });

  $(document).on("click", ".reject-btn", function () {
    $.post(`/newreject/${encodeURIComponent($(this).data("email"))}`)
      .done(() => { showNotification("User rejected successfully!"); fetchUsers(); })
      .fail(() => { showNotification("Rejection failed."); });
  });

  $(document).on("click", ".delete-btn", function () {
    $.post(`/newdelete_user/${encodeURIComponent($(this).data("email"))}`)
      .done(() => { showNotification("User deleted."); fetchUsers(); })
      .fail(() => { showNotification("Delete failed."); });
  });

  $(document).on("click", ".info-btn", function () {
    $("#modal-device-name").text($(this).data("name") || "N/A");
    $("#modal-device-uuid").text($(this).data("uuid") || "N/A");
    $("#modal-registered-at").text($(this).data("registered") || "N/A");
    new bootstrap.Modal(document.getElementById("deviceInfoModal")).show();
  });

  $(function () {
    function getActiveTable() {
      const activeId = $('.tab-pane.active table').attr('id');
      return activeId ? $('#' + activeId).DataTable() : null;
    }
    $('#btnExcel').on('click', () => { const dt = getActiveTable(); if (dt) dt.button('.buttons-excel').trigger(); });
    $('#btnPDF').on('click',   () => { const dt = getActiveTable(); if (dt) dt.button('.buttons-pdf').trigger(); });
    $('#btnPrint').on('click', () => { const dt = getActiveTable(); if (dt) dt.button('.buttons-print').trigger(); });
    $('#toolbarSearch').on('keyup change', function () { const dt = getActiveTable(); if (dt) dt.search(this.value).draw(); });
    $('#refresh-btn').on('click', e => { e.preventDefault(); fetchUsers(); });
    $(document).on('shown.bs.tab', '[data-bs-toggle="tab"]', function () {
      $('#toolbarSearch').val(''); const dt = getActiveTable(); if (dt) dt.search('').draw();
    });
    fetchUsers();
  });
</script>

{% endblock %}
